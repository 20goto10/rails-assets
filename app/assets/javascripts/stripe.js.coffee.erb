DEFAUT_AMOUNT = 5
SUCCESS_MESSAGE = 'Thank you for your donation! Your help keeps Rails Assets running.'

DonationController = ($scope, $http, notifications) ->
  handler = StripeCheckout.configure
    key: '<%= Rails.configuration.stripe[:publishable_key] %>'
    locale: 'auto'
    token: (token) ->
      onSuccess = (response) -> notifications.showSuccess(SUCCESS_MESSAGE)
      onError = (response) -> notifications.showError(message: response.data.error)

      $http.post(Routes.donations_path(), { amount: $scope.amount, token: token }).then onSuccess, onError

  $scope.amount = DEFAUT_AMOUNT

  $scope.invoke = ->
    handler.open
      name: 'Rails Assets'
      description: 'Donation'
      amount: $scope.amount * 100

angular.module('rails-assets').controller 'DonationCtrl', [
  '$scope',
  '$http',
  'notifications',
  DonationController
]
